{% extends "layouts/base.html" %}
{% load static %}

{% block title %}{{ action }} Memo{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Page Header -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center py-4">
                <div class="d-flex align-items-center">
                    <h1 class="h3 mb-0">
                        <i class="fas fa-file-alt text-primary me-2"></i>
                        {{ action }} Memo
                    </h1>
                </div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="{% url 'memos:department_dashboard' %}">Memos</a></li>
                        <li class="breadcrumb-item active">{{ action }}</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <!-- Main Form -->
    <div class="row">
        <div class="col-12">
            <div class="card border-light shadow-sm">
                <div class="card-header bg-primary text-white">
                    <div class="row align-items-center">
                        <div class="col">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-edit me-2"></i>
                                Memo Details
                            </h5>
                        </div>
                    </div>
                </div>
                
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="memoForm">
                        {% csrf_token %}
                        
                        <!-- Basic Information Section -->
                        <div class="card border-light shadow-sm mb-4">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-info-circle text-primary me-2"></i>
                                    Basic Information
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.title.id_for_label }}" class="form-label">
                                            {{ form.title.label }} <span class="text-danger">*</span>
                                        </label>
                                        {{ form.title }}
                                        {% if form.title.errors %}
                                            <div class="invalid-feedback d-block">{{ form.title.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.memo_type.id_for_label }}" class="form-label">
                                            {{ form.memo_type.label }} <span class="text-danger">*</span>
                                        </label>
                                        {{ form.memo_type }}
                                        {% if form.memo_type.errors %}
                                            <div class="invalid-feedback d-block">{{ form.memo_type.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.category.id_for_label }}" class="form-label">
                                            {{ form.category.label }}
                                        </label>
                                        {{ form.category }}
                                        {% if form.category.errors %}
                                            <div class="invalid-feedback d-block">{{ form.category.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.priority.id_for_label }}" class="form-label">
                                            {{ form.priority.label }} <span class="text-danger">*</span>
                                        </label>
                                        {{ form.priority }}
                                        {% if form.priority.errors %}
                                            <div class="invalid-feedback d-block">{{ form.priority.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="{{ form.subject.id_for_label }}" class="form-label">
                                        {{ form.subject.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.subject }}
                                    {% if form.subject.errors %}
                                        <div class="invalid-feedback d-block">{{ form.subject.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-3">
                                    <label for="{{ form.content.id_for_label }}" class="form-label">
                                        {{ form.content.label }}
                                    </label>
                                    {{ form.content }}
                                    {% if form.content.errors %}
                                        <div class="invalid-feedback d-block">{{ form.content.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Memo Properties Section -->
                        <div class="card border-light shadow-sm mb-4">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-cogs text-info me-2"></i>
                                    Memo Properties
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.due_date.id_for_label }}" class="form-label">
                                            {{ form.due_date.label }}
                                        </label>
                                        {{ form.due_date }}
                                        {% if form.due_date.errors %}
                                            <div class="invalid-feedback d-block">{{ form.due_date.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.file_number.id_for_label }}" class="form-label">
                                            {{ form.file_number.label }}
                                        </label>
                                        {{ form.file_number }}
                                        {% if form.file_number.errors %}
                                            <div class="invalid-feedback d-block">{{ form.file_number.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check">
                                            {{ form.is_physical }}
                                            <label class="form-check-label" for="{{ form.is_physical.id_for_label }}">
                                                {{ form.is_physical.label }}
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check">
                                            {{ form.is_confidential }}
                                            <label class="form-check-label" for="{{ form.is_confidential.id_for_label }}">
                                                {{ form.is_confidential.label }}
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="{{ form.tags.id_for_label }}" class="form-label">
                                        {{ form.tags.label }}
                                    </label>
                                    {{ form.tags }}
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Enter tags separated by commas (e.g., urgent, finance, policy)
                                    </div>
                                    {% if form.tags.errors %}
                                        <div class="invalid-feedback d-block">{{ form.tags.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sender Information Section -->
                        <div class="card border-light shadow-sm mb-4">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-user-edit text-success me-2"></i>
                                    Sender Information
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.sender_internal.id_for_label }}" class="form-label">
                                            {{ form.sender_internal.label }}
                                        </label>
                                        {{ form.sender_internal }}
                                        {% if form.sender_internal.errors %}
                                            <div class="invalid-feedback d-block">{{ form.sender_internal.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.sender_external_name.id_for_label }}" class="form-label">
                                            {{ form.sender_external_name.label }}
                                        </label>
                                        {{ form.sender_external_name }}
                                        {% if form.sender_external_name.errors %}
                                            <div class="invalid-feedback d-block">{{ form.sender_external_name.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.sender_external_organization.id_for_label }}" class="form-label">
                                            {{ form.sender_external_organization.label }}
                                        </label>
                                        {{ form.sender_external_organization }}
                                        {% if form.sender_external_organization.errors %}
                                            <div class="invalid-feedback d-block">{{ form.sender_external_organization.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.sender_external_address.id_for_label }}" class="form-label">
                                            {{ form.sender_external_address.label }}
                                        </label>
                                        {{ form.sender_external_address }}
                                        {% if form.sender_external_address.errors %}
                                            <div class="invalid-feedback d-block">{{ form.sender_external_address.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Recipient Information Section -->
                        <div class="card border-light shadow-sm mb-4">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-users text-warning me-2"></i>
                                    Recipient Information
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.recipient_departments.id_for_label }}" class="form-label">
                                            {{ form.recipient_departments.label }}
                                        </label>
                                        {{ form.recipient_departments }}
                                        {% if form.recipient_departments.errors %}
                                            <div class="invalid-feedback d-block">{{ form.recipient_departments.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.recipient_users.id_for_label }}" class="form-label">
                                            {{ form.recipient_users.label }}
                                        </label>
                                        {{ form.recipient_users }}
                                        {% if form.recipient_users.errors %}
                                            <div class="invalid-feedback d-block">{{ form.recipient_users.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.recipient_external_name.id_for_label }}" class="form-label">
                                            {{ form.recipient_external_name.label }}
                                        </label>
                                        {{ form.recipient_external_name }}
                                        {% if form.recipient_external_name.errors %}
                                            <div class="invalid-feedback d-block">{{ form.recipient_external_name.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.recipient_external_organization.id_for_label }}" class="form-label">
                                            {{ form.recipient_external_organization.label }}
                                        </label>
                                        {{ form.recipient_external_organization }}
                                        {% if form.recipient_external_organization.errors %}
                                            <div class="invalid-feedback d-block">{{ form.recipient_external_organization.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="{{ form.recipient_external_address.id_for_label }}" class="form-label">
                                        {{ form.recipient_external_address.label }}
                                    </label>
                                    {{ form.recipient_external_address }}
                                    {% if form.recipient_external_address.errors %}
                                        <div class="invalid-feedback d-block">{{ form.recipient_external_address.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- File Attachments Section -->
                        <div class="card border-light shadow-sm mb-4">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-paperclip text-secondary me-2"></i>
                                    File Attachments
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-upload me-2"></i>
                                        Upload Documents
                                    </label>
                                    <div class="border border-2 border-dashed border-light rounded p-4 text-center" id="dropZone">
                                        <div class="mb-3">
                                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                            <h6 class="text-muted">Drop files here or click to browse</h6>
                                            <p class="text-muted small mb-0">Supported formats: PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX, JPG, PNG</p>
                                            <p class="text-muted small">Maximum file size: 10MB per file</p>
                                        </div>
                                        <input type="file" id="fileInput" name="attachments" multiple 
                                               accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png"
                                               class="d-none">
                                        <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click()">
                                            <i class="fas fa-folder-open me-2"></i>
                                            Browse Files
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- File List Display -->
                                <div id="fileList" class="mt-3" style="display: none;">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-list me-2"></i>
                                        Selected Files
                                    </h6>
                                    <div id="fileItems" class="list-group">
                                        <!-- Files will be added here dynamically -->
                                    </div>
                                </div>
                                
                                <!-- Google Drive Integration Notice -->
                                <div class="alert alert-info mt-3">
                                    <div class="d-flex align-items-center">
                                        <i class="fab fa-google-drive fa-2x text-primary me-3"></i>
                                        <div>
                                            <h6 class="alert-heading mb-1">Google Drive Integration</h6>
                                            <p class="mb-0 small">Files will be automatically uploaded to Google Drive and linked to this memo for secure storage and sharing.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Form Actions -->
                        <div class="card border-light shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-end gap-3">
                                    <a href="{% url 'memos:my_memos' %}" class="btn btn-light">
                                        <i class="fas fa-times me-2"></i>
                                        Cancel
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>
                                        {{ action }} Memo
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Select2 for multi-select fields with Bootstrap 5 theme
    $('.select2').select2({
        theme: 'bootstrap-5',
        width: '100%',
        placeholder: function(){
            return $(this).data('placeholder');
        }
    });
    
    // Form validation
    document.getElementById('memoForm').addEventListener('submit', function(e) {
        const title = document.getElementById('{{ form.title.id_for_label }}').value;
        const subject = document.getElementById('{{ form.subject.id_for_label }}').value;
        
        if (!title.trim() || !subject.trim()) {
            e.preventDefault();
            // Use Bootstrap toast for validation messages
            showToast('Please fill in all required fields (Title and Subject).', 'warning');
            return false;
        }
    });
    
    // Auto-expand textarea
    const textareas = document.querySelectorAll('textarea');
    textareas.forEach(textarea => {
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
    });
    
    // Helper function for toast notifications (if available in your base template)
    function showToast(message, type = 'info') {
        if (typeof createToast === 'function') {
            createToast(message, type);
        } else {
            alert(message);
        }
    }
    
    // File Upload Functionality
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    const fileList = document.getElementById('fileList');
    const fileItems = document.getElementById('fileItems');
    let selectedFiles = [];
    
    // File input change handler
    fileInput.addEventListener('change', function(e) {
        handleFiles(Array.from(e.target.files));
    });
    
    // Drag and drop handlers
    dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropZone.classList.add('border-primary', 'bg-light');
    });
    
    dropZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        dropZone.classList.remove('border-primary', 'bg-light');
    });
    
    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropZone.classList.remove('border-primary', 'bg-light');
        const files = Array.from(e.dataTransfer.files);
        handleFiles(files);
    });
    
    // Handle file selection
    function handleFiles(files) {
        files.forEach(file => {
            // Validate file size (10MB limit)
            if (file.size > 10 * 1024 * 1024) {
                showToast(`File "${file.name}" is too large. Maximum size is 10MB.`, 'warning');
                return;
            }
            
            // Validate file type
            const allowedTypes = [
                'application/pdf',
                'application/msword',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'application/vnd.ms-excel',
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'application/vnd.ms-powerpoint',
                'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                'image/jpeg',
                'image/jpg',
                'image/png'
            ];
            
            if (!allowedTypes.includes(file.type)) {
                showToast(`File "${file.name}" is not a supported format.`, 'warning');
                return;
            }
            
            // Check if file already selected
            if (selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
                showToast(`File "${file.name}" is already selected.`, 'info');
                return;
            }
            
            selectedFiles.push(file);
            addFileToList(file);
        });
        
        updateFileList();
    }
    
    // Add file to display list
    function addFileToList(file) {
        const fileSize = formatFileSize(file.size);
        const fileIcon = getFileIcon(file.type);
        
        const fileItem = document.createElement('div');
        fileItem.className = 'list-group-item d-flex justify-content-between align-items-center';
        fileItem.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="${fileIcon} fa-lg text-primary me-3"></i>
                <div>
                    <h6 class="mb-0">${file.name}</h6>
                    <small class="text-muted">${fileSize}</small>
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile('${file.name}', ${file.size})">
                <i class="fas fa-trash"></i>
            </button>
        `;
        
        fileItems.appendChild(fileItem);
    }
    
    // Remove file from selection
    window.removeFile = function(fileName, fileSize) {
        selectedFiles = selectedFiles.filter(f => !(f.name === fileName && f.size === fileSize));
        updateFileList();
    };
    
    // Update file list display
    function updateFileList() {
        if (selectedFiles.length > 0) {
            fileList.style.display = 'block';
            fileItems.innerHTML = '';
            selectedFiles.forEach(file => addFileToList(file));
        } else {
            fileList.style.display = 'none';
        }
        
        // Update file input
        const dt = new DataTransfer();
        selectedFiles.forEach(file => dt.items.add(file));
        fileInput.files = dt.files;
    }
    
    // Format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // Get file icon based on type
    function getFileIcon(fileType) {
        const iconMap = {
            'application/pdf': 'fas fa-file-pdf',
            'application/msword': 'fas fa-file-word',
            'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'fas fa-file-word',
            'application/vnd.ms-excel': 'fas fa-file-excel',
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'fas fa-file-excel',
            'application/vnd.ms-powerpoint': 'fas fa-file-powerpoint',
            'application/vnd.openxmlformats-officedocument.presentationml.presentation': 'fas fa-file-powerpoint',
            'image/jpeg': 'fas fa-file-image',
            'image/jpg': 'fas fa-file-image',
            'image/png': 'fas fa-file-image'
        };
        
        return iconMap[fileType] || 'fas fa-file';
    }
        } else {
            alert(message);
        }
    }
});
</script>
{% endblock %}
