{% extends "layouts/base.html" %}
{% load crispy_forms_tags %}

{% block title %} Task Dashboard - {{ department.name }} {% endblock %}

{% block content %}
<style>
    /* Custom styles for Judiciary Theme */
    .judiciary-bg-green { background-color: #006633 !important; }
    .judiciary-text-gold { color: #DAA520 !important; }
    .judiciary-border-gold { border-color: #DAA520 !important; }
    .judiciary-text-light-grey { color: #f0f0f0 !important; }

    /* Style for cards in this view */
    .task-card .card-header {
        background-color: #006633;
        color: #FFFFFF; /* Default text color for header */
        border-bottom: 2px solid #DAA520;
    }
    /* Explicitly target h6 inside the header */
    .task-card .card-header h6 {
        color: #FFFFFF !important; /* Ensure heading text is white */
    }
    .task-card .card-body {
        /* Use a slightly transparent dark background or keep page default */
        /* background-color: rgba(0, 0, 0, 0.1); */
        color: #333; /* Default dark text for contrast on light bg */
    }
    .task-card .list-group-item {
        background-color: transparent;
        border-color: #e0e0e0; /* Light border for items */
        color: #333; /* Default dark text */
    }
    .task-card .list-group-item a {
        color: #006633; /* Green links for task titles */
        font-weight: 500;
    }
    .task-card .list-group-item a:hover {
        text-decoration: underline;
    }
    .task-card .list-group-item small {
        color: #6c757d; /* Standard muted color */
    }
    .task-card .list-group-item .btn-outline-secondary {
        color: #6c757d;
        border-color: #6c757d;
    }
     .task-card .list-group-item .btn-outline-secondary:hover {
        background-color: #6c757d;
        color: #FFFFFF;
    }
    .task-card .card-body p { /* For 'no tasks' message */
        color: #6c757d;
    }

    /* Project Summary Card Styles */
    .project-summary-card .card-header {
        background-color: #f8f9fa; /* Standard light header */
        border-bottom: 1px solid #dee2e6;
    }
     .project-summary-card .card-header h6 {
        color: #006633; /* Green header text */
     }
    .project-summary-card .list-group-item {
        border-color: #dee2e6;
        color: #333; /* Default text color */
    }
    .project-summary-card .list-group-item i {
        color: #006633; /* Green icon */
    }
     .project-summary-card .list-group-item small {
        color: #6c757d;
     }
     .project-summary-card .list-group-item:hover {
        background-color: #e9ecef;
     }

     /* Modal Styles */
    .judiciary-modal .modal-header {
        background-color: #006633;
        color: #FFFFFF;
        border-bottom: 2px solid #DAA520;
    }
     .judiciary-modal .modal-header .btn-close {
        filter: brightness(0) invert(1); /* Make close button white */
     }
    .judiciary-modal .btn-judiciary-primary {
        background-color: #006633;
        color: #FFFFFF;
        border-color: #005a30;
    }
     .judiciary-modal .btn-judiciary-primary:hover {
        background-color: #005a30;
     }

</style>

<div class="container-fluid mt-4">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0" style="color: #006633;">
            <i class="fas fa-tachometer-alt me-2 judiciary-text-gold"></i> {{ department.name }} - Task Dashboard
        </h1>
        <button type="button" class="btn btn-sm shadow-sm judiciary-bg-green text-white" data-bs-toggle="modal" data-bs-target="#createProjectModal">
            <i class="fas fa-plus fa-sm me-1"></i> Create New Project
        </button>
    </div>
    <hr class="judiciary-border-gold">

    <div class="row">

        {# My Tasks Card #}
        <div class="col-xl-6 col-lg-6 mb-4">
            <div class="card shadow h-100 task-card">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold"><i class="fas fa-user-check me-2 judiciary-text-gold"></i> My Assigned Tasks</h6>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    {% if my_tasks %}
                        <ul class="list-group list-group-flush">
                            {% for task in my_tasks %}
                            <li class="list-group-item d-flex justify-content-between align-items-center px-2 py-2">
                                <div>
                                    <a href="{% url 'tasks:task_detail' task.id %}" class="text-decoration-none">{{ task.title }}</a><br>
                                    <small>Project: {{ task.project.name }} | Status: {{ task.get_status_display }} | Due: {{ task.due_date|date:"Y-m-d"|default:"N/A" }}</small>
                                </div>
                                <a href="{% url 'tasks:task_detail' task.id %}" class="btn btn-outline-secondary btn-sm py-0 px-1" title="View Task"><i class="fas fa-eye"></i></a>
                            </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-center mt-3">You have no active assigned tasks in this department.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        {# Due Soon Tasks Card #}
        <div class="col-xl-6 col-lg-6 mb-4">
            <div class="card shadow h-100 task-card">
                 <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold"><i class="fas fa-calendar-alt me-2 judiciary-text-gold"></i> Tasks Due Soon (Next 7 Days)</h6>
                 </div>
                 <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                     {% if due_soon_tasks %}
                        <ul class="list-group list-group-flush">
                            {% for task in due_soon_tasks %}
                            <li class="list-group-item d-flex justify-content-between align-items-center px-2 py-2 {% if task.due_date == today %} border border-danger {% endif %}">
                                <div>
                                    <a href="{% url 'tasks:task_detail' task.id %}" class="text-decoration-none">{{ task.title }}</a><br>
                                    <small>
                                        Project: {{ task.project.name }} |
                                        Assignee: {{ task.assignee.get_full_name|default:task.assignee.username|default:"Unassigned" }} |
                                        Due: <strong>{{ task.due_date|date:"Y-m-d" }}</strong>
                                    </small>
                                </div>
                                <a href="{% url 'tasks:task_detail' task.id %}" class="btn btn-outline-secondary btn-sm py-0 px-1" title="View Task"><i class="fas fa-eye"></i></a>
                            </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-center mt-3">No tasks due soon in this department.</p>
                    {% endif %}
                 </div>
            </div>
        </div>

    </div>

    {# Projects Summary Card #}
    <div class="row">
        <div class="col-12">
            <div class="card shadow mb-4 project-summary-card">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold"><i class="fas fa-folder me-2 judiciary-text-gold"></i> Project Summary</h6>
                </div>
                <div class="card-body">
                    {% if projects %}
                        <div class="list-group list-group-horizontal-sm flex-wrap">
                            {% for project in projects %}
                                 <a href="{% url 'tasks:project_detail' project.id %}" class="list-group-item list-group-item-action mb-2 me-2" style="flex-basis: auto; min-width: 180px;">
                                    <i class="fas fa-project-diagram me-1"></i> {{ project.name }}
                                    <br><small>Owner: {{ project.owner.username|default:'N/A' }}</small>
                                 </a>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">No projects found for this department.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>


    <div class="mt-3 mb-4">
        <a href="{% url 'apps.home:department_modules' department.id %}" class="btn btn-secondary btn-sm"><i class="fas fa-arrow-left me-1"></i> Back to Department Modules</a>
    </div>

</div>

{# Create Project Modal #}
<div class="modal fade judiciary-modal" id="createProjectModal" tabindex="-1" aria-labelledby="createProjectModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createProjectModalLabel"><i class="fas fa-folder-plus me-2 judiciary-text-gold"></i> Create New Project for {{ department.name }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'tasks:department_task_project_list' department.id %}">
          {% csrf_token %}
          <div class="modal-body">
              {{ project_form|crispy }}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-judiciary-primary">Create Project</button>
          </div>
      </form>
    </div>
  </div>
</div>

{% endblock content %}